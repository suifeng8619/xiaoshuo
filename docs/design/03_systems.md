# 系统设计文档

## 核心设计理念

**我们要做的是一个活的世界，不是剧本式的固定场景。**

所有系统服务于一个目标：**让玩家在乎**。

- NPC有自己的作息，不是等着玩家触发
- 时间在流逝，错过就是错过
- 相遇是自然发生的，不是预设剧情
- 选择有重量，后果有延迟

---

## 一、时间系统（核心）

时间是这个游戏最核心的系统，驱动整个世界运转。

### 1.1 双层时间结构

```yaml
时间层级:
  行动层 (Action Tick):
    - 最小单位，每个行动消耗若干时间
    - 对话: 1-2时辰
    - 采药/短途移动: 2-4时辰
    - 修炼: 1-3天
    - 闭关: 数月到数年
    - 远行历练: 数天到数月

  日循环层 (Day Cycle):
    - 每天分为4个时段：早(卯-辰)、午(巳-午)、晚(未-酉)、夜(戌-子)
    - NPC日程按时段运行
    - 每日事件检查在日结算时进行

  季节层 (Season):
    - 每季度3个月，影响事件池和资源
    - 春/夏/秋/冬各有特定事件窗口
    - 某些秘境只在特定季节开启

时间换算:
  1天 = 12时辰 = 4时段
  1月 = 30天
  1季 = 3月
  1年 = 12月 = 4季

  游戏内1年 ≈ 现实2-3小时游玩
```

### 1.2 时段定义

```yaml
时段详情:
  早 (morning):
    时辰: 卯时-辰时 (05:00-09:00)
    典型活动: 早课、晨练、洒扫
    NPC状态: 精神饱满

  午 (afternoon):
    时辰: 巳时-午时 (09:00-13:00)
    典型活动: 修炼、任务、采药
    NPC状态: 活跃

  晚 (evening):
    时辰: 未时-酉时 (13:00-19:00)
    典型活动: 自由活动、会友、采购
    NPC状态: 放松

  夜 (night):
    时辰: 戌时-子时 (19:00-01:00)
    典型活动: 夜修、休息、密谈
    NPC状态: 疲惫/警惕
```

### 1.3 长行动结算流程

当玩家执行超过1天的行动（如闭关、远行）时：

```yaml
长行动结算:
  1. 计算持续天数:
     - 闭关修炼: 根据目标境界计算
     - 远行历练: 根据目的地距离计算
     - 疗伤恢复: 根据伤势严重程度计算

  2. 逐日快速模拟:
     for each day in duration:
       - 执行所有NPC的日程（压缩处理）
       - 检查时间窗事件
       - roll随机扰动
       - 更新世界状态标记

  3. 事件检查:
     - 如果有高优先级事件满足触发条件
     - 且事件标记为 interrupt: true
     - 则插入中断（如"第三天夜里有人敲门"）
     - 否则事件排队到行动结束

  4. 结算输出:
     - 只对"关键事件"产出叙事
     - 日常事件静默结算（如"这些天阿檀照常过日子"）
     - 保持"状态连续但叙事稀疏"

示例:
  玩家选择闭关30天
  → 系统逐日模拟NPC日程
  → 第7天检测到"阿檀生病"事件触发
  → 因为 interrupt: false，事件排队
  → 第30天结束，输出："你出关时，听说阿檀前些日子病了一场，如今已好转。"

  如果事件是"仇人袭击"且 interrupt: true
  → 第15天强制中断闭关
  → 输出："一声巨响将你从定中唤醒——有人闯入山门！"
```

### 1.4 时间的影响

```yaml
角色衰老:
  凡人:
    - 20年：青年→中年
    - 50年：中年→老年
    - 80年：大限将至
    - 阿檀如果不修炼，会老去

  修士寿命:
    练气期: 150-200年
    筑基期: 300-500年
    金丹期: 800-1000年
    元婴期: 1500-2000年

  时间压力:
    - 玩家闭关太久，出来可能阿檀已经嫁人/老去/死亡
    - 这是推动情感冲突的核心机制

世界变化:
  势力消长:
    - 宗门兴衰（每10年结算一次）
    - 战争爆发与结束
    - 新势力崛起

  人事变迁:
    - NPC会升职、离开、死亡
    - 仇人也会变强
    - 机缘可能错过
```

---

## 二、空间系统

### 2.1 节点图结构

不使用坐标系统，而是使用**节点图**：

```yaml
空间层级:
  区域 (Region):
    - 最大单位：东域、西域、北域、南域
    - 跨区域移动需要数周到数月

  势力范围 (Territory):
    - 中等单位：青云门、万剑宗、某城市
    - 势力内移动需要数天

  地点节点 (Location Node):
    - 基本单位：演武场、藏经阁、溪边
    - 节点间移动需要数时辰

  热点 (Hotspot):
    - 节点内的互动点：大石头、竹林、药圃
    - 用于定位NPC和触发互动

节点示例 - 青云门:
  青云门:
    type: territory
    nodes:
      - 山门
      - 外门广场
      - 演武场
      - 藏经阁
      - 药圃
      - 后山溪边
      - 云霞峰（内门）
      - 长老殿

  后山溪边:
    type: location
    hotspots:
      - 大石头（常有人在此发呆）
      - 浅水处（可以洗衣/洗漱）
      - 竹林边（隐蔽，适合密谈）
    adjacent: [药圃, 外门广场, 山间小路]
    travel_time: 1时辰 from 外门广场
```

### 2.2 节点属性

```yaml
location_node:
  id: "stream_behind_mountain"
  name: "后山溪边"
  type: location

  # 环境属性
  environment:
    terrain: 溪流
    features: [大石头, 清澈溪水, 竹林, 野花]
    atmosphere: 宁静
    lighting: 随时间变化

  # 可用行动
  available_actions:
    - 洗衣
    - 打水
    - 发呆
    - 采集（溪边草药）

  # 连接节点
  adjacent:
    药圃: 0.5时辰
    外门广场: 1时辰
    山间小路: 2时辰

  # 事件绑定
  bound_events:
    - "溪边偶遇"
    - "夜间密谈"
```

---

## 三、NPC日程系统

### 3.1 日程结构

每个重要NPC都有预设的日程表：

```yaml
npc_schedule:
  id: "atan"
  name: "阿檀"

  # 基础日程（按时段）
  default_schedule:
    早 (morning):
      location: 外门杂役房
      activity: 洒扫/打水
      interruptible: true
      priority: 3

    午 (afternoon):
      location: 后山溪边 | 药圃  # 轮换
      activity: 洗衣 | 采药
      interruptible: true
      priority: 3

    晚 (evening):
      location: 外门广场 | 玩家住处附近
      activity: 自由活动/等待玩家
      interruptible: true
      priority: 2

    夜 (night):
      location: 杂役房
      activity: 缝补/休息
      interruptible: false  # 除非紧急
      priority: 4

  # 条件覆盖
  conditional_overrides:
    - condition: "relationship.affection >= 70"
      时段: 晚
      location: 玩家住处门口
      activity: 等待

    - condition: "flag:阿檀生病"
      all_slots: true
      location: 杂役房
      activity: 卧床休息

    - condition: "玩家外出历练"
      时段: 晚
      location: 山门
      activity: 眺望/等待
```

### 3.2 日程打断规则

```yaml
interrupt_rules:
  优先级定义:
    1: 危机（必须响应）—— 战斗、灾难、生死
    2: 紧急（应该响应）—— 玩家召唤、重要NPC传唤
    3: 普通（可被打断）—— 日常任务
    4: 固定（不可打断）—— 休息、疗伤
    5: 灵活（随时可打断）—— 发呆、闲逛

  打断流程:
    1. 新事件到来，携带优先级
    2. 对比当前活动优先级
    3. 如果新事件优先级更高（数字更小）：
       - 保存当前活动到栈
       - 切换到新活动
    4. 事件结束后：
       - 检查栈中是否有未完成活动
       - 如果有且仍在时间窗内，恢复
       - 否则推进到下一个日程时段

  恢复机制:
    - 短暂打断（<1时辰）：恢复原活动
    - 长打断（>=1时辰）：跳到下一时段
    - 跨日打断：重新按日程执行
```

### 3.3 NPC目标与动机

除了日程，NPC还有长期目标驱动行为：

```yaml
npc_goals:
  阿檀:
    核心目标:
      - 陪伴玩家 (weight: 0.4)
      - 自身安全 (weight: 0.3)
      - 修炼提升 (weight: 0.2)
      - 报答师恩 (weight: 0.1)

    禁忌 (hard_constraints):
      - 不主动杀人
      - 不背叛玩家（除非信任<10）
      - 不离开安全区太久（除非为了玩家）

    性格驱动:
      - 温柔但有底线
      - 害怕失去
      - 会为玩家牺牲但会犹豫

  目标冲突处理:
    当多个目标冲突时:
      1. 按权重选择
      2. 考虑当前情绪状态
      3. 参考历史选择倾向
      4. 关键时刻：生成选择事件让玩家见证
```

### 3.4 随机扰动

防止世界过于机械：

```yaml
random_perturbation:
  每日roll:
    概率: 10%
    类型池:
      - 身体不适（5%）
      - 被人欺负（3%，如果地位低）
      - 得知秘闻（2%）
      - 捡到东西（2%）
      - 心事重重（3%）

  扰动效果:
    - 可能触发事件入口
    - 影响当日心情
    - 可能改变日程

  示例:
    roll结果: 阿檀身体不适
    效果:
      - 当日午后改为在杂役房休息
      - 心情: 低落
      - 如果玩家来找，触发"阿檀小恙"事件
```

---

## 四、事件系统（核心）

### 4.1 事件池架构

**取代线性剧情，用事件池驱动叙事：**

```yaml
事件池层级:
  日常事件池 (Daily):
    - 高频、低冲击
    - 如：闲聊、日常互动、小发现
    - 每天可触发多个
    - 冷却：1-3天

  机缘事件池 (Opportunity):
    - 中频、中冲击
    - 如：发现秘境线索、遇到散修、获得功法
    - 每周触发1-2个
    - 冷却：7-30天

  关键事件池 (Critical):
    - 低频、高冲击
    - 如：玄影初遇、师父受伤、宗门大比
    - 每月触发0-1个
    - 冷却：30-180天

事件互斥:
  - 同层事件有并发上限（日常≤3，机缘≤2，关键≤1）
  - 某些事件互斥（不能同时"阿檀生病"和"阿檀外出"）
```

### 4.2 事件数据结构

```yaml
event:
  # 基础信息
  id: "event_玄影初遇"
  name: "玄影初遇"
  category: encounter  # encounter/plot/daily/crisis
  tier: critical       # daily/opportunity/critical

  # 调度参数
  priority: 0.7        # 0-1，用于择机插入
  cooldown: 180d       # 触发后冷却时间
  max_triggers: 1      # 最多触发次数（1=一次性事件）

  # 触发窗口
  window:
    time:
      year_min: 1
      year_max: 8
      season: [春, 秋]  # 可选季节限制
    locations:
      - 矿洞节点
      - 护送路段节点

  # 前置条件
  preconditions:
    flags_required: []
    flags_absent:
      - 玄影身份揭露
    player:
      realm_min: 练气3
      realm_max: null
      injury_state: "!dying"
    npc_states:
      玄影: alive
    relationship: {}

  # 触发方式
  triggers:
    - type: location_enter      # 进入特定地点
      locations: [矿洞节点]
    - type: time_window         # 时间窗口自动检查
      check_interval: daily
    - type: random              # 随机触发
      daily_chance: 0.05

  # 打断设置
  interrupt: false              # 是否打断玩家当前行动
  interrupt_dialogue: false     # 是否打断当前对话

  # 事件效果
  effects:
    set_flags:
      - 玄影已见面
    clear_flags: []
    relationship_changes:
      - npc: 玄影
        changes:
          mystery: +10
    schedule_followups:
      - event_id: event_玄影再见
        delay: 6-18个月
    world_state_changes: {}

  # 事件变体
  variants:
    - id: rescue
      trigger_condition: "玩家主动救助"
      ai_prompt_tags:
        - 感激
        - 隐匿身份
        - 欲言又止
      extra_effects:
        relationship_changes:
          - npc: 玄影
            changes:
              trust: +5

    - id: observe
      trigger_condition: "玩家路过旁观"
      ai_prompt_tags:
        - 打量
        - 警惕
        - 自行脱困

  # 叙事资源
  narrative:
    opening_template: |
      你在{location}行走时，听到前方传来打斗声...
    ai_generation: true
    ai_constraints:
      - 不要透露玄影真实身份
      - 描写要有悬念感
```

### 4.3 事件选择算法

```yaml
event_selection:
  每个tick执行:
    1. 收集所有可触发事件:
       - 检查时间窗口
       - 检查地点条件
       - 检查前置条件
       - 检查冷却状态

    2. 计算综合评分:
       score = priority × 0.4
             + urgency × 0.3      # 临近过期的事件更紧急
             + relevance × 0.2    # 与当前情境相关性
             + random × 0.1       # 随机因子

    3. 按层级筛选:
       - 如果有critical事件且分数>0.6，优先触发
       - 否则按层级配额分配

    4. 冲突检查:
       - 检查互斥组
       - 检查并发上限

    5. 触发或排队:
       - 可立即触发：加入当前场景
       - 需排队：加入pending_events

  打断处理:
    if event.interrupt and 玩家正在行动:
      if event.tier == crisis:
        强制打断
      elif 行动可中断:
        询问玩家是否响应
      else:
        排队等待
```

### 4.4 事件触发来源

```yaml
触发来源:
  时间触发:
    - 每日检查：日常事件池
    - 每周检查：机缘事件池
    - 每月检查：关键事件池
    - 特定日期：节日、纪念日

  地点触发:
    - 进入节点时检查绑定事件
    - 首次进入触发探索事件

  关系触发:
    - 关系值跨越阈值（如affection>=80）
    - 关系状态变化（friend→close_friend）

  日程触发:
    - NPC日程执行到特定活动
    - 日程冲突时

  行动触发:
    - 玩家特定行动（修炼突破、战斗胜利）
    - 消耗特定资源

  世界态势触发:
    - 战争状态变化
    - 灾难发生
    - 秘境开放

  随机触发:
    - 每日roll
    - 基于气运值
```

---

## 五、叙事吸引子系统

### 5.1 防止世界"跑偏"

```yaml
叙事吸引子:
  定义:
    在开放世界中保持叙事节奏的机制
    不强制剧情，但引导玩家体验关键内容

  实现方式:
    季度推送:
      - 每季度初，将1-2个主矛盾相关事件加入"推荐池"
      - 提高这些事件的priority
      - 玩家可以忽略，但世界会继续演化

    错过惩罚:
      - 事件有expiry（过期时间）
      - 过期后自动结算后果（规则表驱动，不用AI）
      - 解锁替代事件（余波/报复/新发展）

    熔断机制:
      - 如果连续N天无关键事件
      - 自动投放：小剧情/资源/危机
      - 保证每X小时游戏时间有"内容"

  示例:
    主矛盾: 仇人追杀
    季度推送: "仇人线索"事件进入推荐池

    玩家忽略30天后:
      事件过期
      后果: 仇人势力扩张，某NPC被波及
      替代事件: "某NPC求助"解锁
```

### 5.2 阶段标记系统

```yaml
世界阶段:
  主矛盾阶段:
    仇人线:
      - phase_0: 潜伏（仇人在暗处）
      - phase_1: 显露（玩家知道仇人存在）
      - phase_2: 冲突（双方有过交手）
      - phase_3: 决战（最终对决）
      - phase_4: 结局（仇人死/和解/逃脱）

    阿檀线:
      - phase_0: 青梅竹马
      - phase_1: 情愫暗生
      - phase_2: 危机考验
      - phase_3: 命运抉择
      - phase_4: 结局分支

  阶段推进:
    - 事件触发可推进阶段
    - 时间流逝可推进阶段（被动推进）
    - 玩家行动可推进阶段

  阶段影响:
    - 不同阶段解锁不同事件池
    - 影响NPC态度和对话
    - 影响世界描述
```

---

## 六、关系系统

### 6.1 多维度关系

```yaml
relationship_dimensions:
  trust: 0-100       # 信任：她相信你吗？
  affection: 0-100   # 情感：她对你有多少好感？
  respect: 0-100     # 尊敬：她尊敬你吗？
  dependency: 0-100  # 依赖：她有多需要你？
  understanding: 0-100 # 理解：她了解你吗？

关系计算:
  不是简单加减，而是基于事件权重:

    事件类型权重:
      生死关头的选择: ×3
      承诺与背诺: ×2
      日常互动: ×1
      时间流逝: ×0.5

    情境修正:
      在她面前做: ×1.2
      她事后知道: ×0.8
      她不知道但影响到她: ×0.6
```

### 6.2 关系状态机

```yaml
relationship_states:
  # 正向状态
  stranger: affection < 20
  acquaintance: affection >= 20, trust >= 20
  friend: affection >= 40, trust >= 30
  close_friend: affection >= 60, trust >= 50
  soulmate: affection >= 80, trust >= 70, understanding >= 60
  lover: affection >= 90, trust >= 80 + 特定事件触发

  # 负向状态
  wary: trust < 30
  hurt: 特殊事件触发（需要修复）
  estranged: trust < 20, 持续30天
  broken: trust < 10（可能无法修复）

状态转换:
  - 跨越阈值自动转换
  - 触发对应事件
  - 解锁/锁定对话选项
  - 影响NPC行为模式
```

### 6.3 关系影响事件

```yaml
关系触发:
  affection >= 60:
    - 解锁"主动找你聊天"日程
    - 解锁亲密对话选项

  trust < 30:
    - 触发"疏远"事件
    - 对话态度变化
    - 可能拒绝某些请求

  understanding >= 50:
    - NPC能"读懂"玩家
    - 对话更有深度
    - 可能主动提供帮助
```

---

## 七、记忆系统

### 7.1 记忆类型

```yaml
memory_types:
  core_memory:      # 核心记忆，永不遗忘
    - 第一次相遇
    - 生死关头的事件
    - 重大选择和后果
    importance: 9-10
    decay: never

  significant_memory:  # 重要记忆，长期保留
    - 承诺和誓言
    - 冲突和和解
    - 共同经历的冒险
    importance: 6-8
    decay: 1年后开始淡化

  casual_memory:    # 日常记忆，会随时间淡忘
    - 普通对话
    - 日常互动
    - 小事件
    importance: 1-5
    decay: 1月后开始淡化

  emotional_memory: # 情感记忆，影响态度
    - 被伤害的感觉
    - 被保护的温暖
    - 被忽视的失落
    importance: varies
    decay: 根据intensity
```

### 7.2 记忆存储结构

```yaml
memory_entry:
  id: "mem_001"
  type: core_memory
  timestamp: "第1年春，入门第3日"

  # 事件内容
  event:
    what: "玩家在演武场被欺负，阿檀冲出来护住玩家"
    who: [玩家, 阿檀, 赵师兄]
    where: 演武场
    action: protect

  # 情感影响
  emotional_impact:
    emotions: [担心, 心疼, 骄傲]
    intensity: 8
    attitude_change:
      affection: +5
      dependency: +3

  # 后续影响
  consequences:
    - "阿檀更加关注玩家安危"
    - "赵师兄记恨"

  # 元数据
  importance: 9
  can_forget: false
  reference_count: 0
  tags: [保护, 演武场, 冲突, 早期]
```

### 7.3 记忆检索

```yaml
memory_query:
  场景: 玩家又要外出历练

  检索过程:
    1. 提取关键词: [外出, 历练, 分别, 危险]
    2. 匹配标签和内容
    3. 按相关性和重要性排序
    4. 返回top-k记忆

  匹配结果:
    - "上次玩家外出，差点死在外面" (importance: 8, 相关性: 0.9)
    - "玩家承诺过会小心" (importance: 6, 相关性: 0.7)
    - "阿檀最怕失去玩家" (importance: 9, 相关性: 0.6)

  用于生成:
    阿檀的对话会自然引用这些记忆
```

---

## 八、AI使用边界

### 8.1 硬逻辑 vs AI生成

```yaml
规则驱动 (硬逻辑):
  - 事件触发判定
  - 数值计算（伤害、关系变化）
  - 时间流逝和日程执行
  - 移动和位置变化
  - 战斗结算
  - 世界状态更新
  - 阶段推进判定

AI生成:
  - NPC对话内容
  - 场景描写
  - 事件文本变体
  - NPC微决策（在已选定的动作框架内）

严禁AI决定:
  - 事件是否触发
  - 关系数值变化
  - 世界阶段推进
  - NPC核心行为（去哪、做什么）
```

### 8.2 AI上下文最小清单

```yaml
传给AI的上下文:
  必须包含:
    # 场景框架
    - 当前地点名称和特征
    - 当前时段（早/午/晚/夜）
    - 天气/氛围

    # NPC状态（规则层已确定）
    - NPC当前行动标签（如"洗衣"、"发呆"）
    - NPC当前心情
    - NPC当前健康状态

    # 关系摘要
    - 关系状态标签（close_friend/lover等）
    - 关系数值区间（不给具体数字，给描述）
    - 未解决的情感冲突

    # 相关记忆
    - 检索到的3-5条相关记忆摘要

    # 禁忌清单
    - 不允许提及的内容
    - 不允许出现的行为
    - 与当前状态冲突的描述

  示例上下文:
    """
    ## 场景
    - 地点：后山溪边
    - 时段：午后
    - 特征：大石头、清澈溪水、竹林掩映

    ## 阿檀当前状态
    - 正在做：洗衣（蹲在水边搓洗道袍）
    - 心情：平静，略有期待
    - 健康：正常

    ## 你们的关系
    - 状态：亲密好友，情愫暗生
    - 她信任你、依赖你
    - 未解决：上次你外出时她很担心

    ## 相关记忆
    - 上次在这里，你帮她晾过衣服
    - 她曾说过喜欢这里的安静
    - 你们在这里有过一次深谈

    ## 禁忌
    - 【不要出现】：竹竿、晾衣架（不在这个场景）
    - 【不要提及】：她的身世秘密（她还不知道）
    """
```

### 8.3 AI输出验证

```yaml
输出验证:
  规则层检查:
    1. 行动一致性:
       - AI说NPC在做什么
       - 对比当前行动标签
       - 不一致则警告/降级

    2. 地点一致性:
       - AI描述中的环境元素
       - 对比当前地点特征
       - 出现矛盾元素则标记

    3. 禁忌检查:
       - 扫描输出文本
       - 检查是否包含禁忌关键词
       - 违规则降级到模板回复

  降级策略:
    - 轻微不一致：AI润色后输出
    - 严重冲突：使用预设模板
    - 多次失败：标记问题，人工排查
```

---

## 九、状态标记系统

### 9.1 标记类型

```yaml
flag_types:
  世界标记:
    - 战争状态：战前/战中/战后
    - 灾难状态：瘟疫/旱灾/妖患
    - 秘境状态：未发现/已发现/已探索
    - 势力状态：青云门兴/衰

  剧情标记:
    - 玄影已见面
    - 师父受伤
    - 仇人暴露
    - 真相得知

  关系标记:
    - 与阿檀表白
    - 与师父决裂
    - 结拜兄弟

  角色标记:
    - 阿檀开始修炼
    - 阿檀受伤
    - 阿檀获得传承

标记用途:
  - 控制事件显隐
  - 影响NPC对话
  - 决定可用选项
  - 驱动世界演化
```

### 9.2 标记管理

```yaml
flag_operations:
  set_flag:
    - 事件效果设置
    - 行动结果设置
    - 时间触发设置

  clear_flag:
    - 事件解决后清除
    - 超时清除
    - 条件清除

  check_flag:
    - 事件前置条件
    - 对话分支
    - 行动可用性

  compound_flags:
    # 组合标记
    "可以告白":
      requires:
        - 关系.affection >= 80
        - 已经历生死考验
        - NOT 与阿檀决裂
```

---

## 十、安全阀与控制

### 10.1 防崩溃机制

```yaml
安全检查:
  事件生成前:
    - 检查NPC存活状态
    - 检查地点可达性
    - 检查禁忌冲突
    - 检查逻辑一致性

  违规处理:
    - 降级：换用备选事件
    - 跳过：记录日志，跳过本次
    - 改写：规则修正后执行

  硬约束:
    - 阵营关系不能突变
    - 死亡NPC不能复活（除非有特殊机制）
    - 境界压制规则不可违反
    - 时间不可倒流
```

### 10.2 内容节奏控制

```yaml
节奏控制:
  每X小时游戏时间保证:
    - 至少1次有意义对话
    - 至少1次小发现/奖励
    - 至少1次选择点

  避免:
    - 连续N天无事发生
    - 同类型事件密集触发
    - 多条高冲突线同时展开

  熔断触发:
    condition: 连续3天无任何事件
    action: 强制投放日常事件
```

---

*本文档定义了游戏世界的运行规则。核心原则：规则驱动世界运转，AI负责叙事润色，玩家选择推动发展。*
