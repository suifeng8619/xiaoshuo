# 系统设计文档

## 核心设计理念

所有系统服务于一个目标：**让玩家在乎**。

不是堆数值，不是刷进度，而是让每一个选择都有重量，让每一段关系都有意义。

---

## 一、时间系统

时间是这个游戏最核心的系统。

### 时间流逝

```yaml
time_scale:
  1行动 = 若干时间（根据行动类型）

  闲聊: 1时辰
  修炼一次: 1天
  外出历练: 数天到数月
  闭关突破: 数月到数年
  重伤恢复: 数月

  1天 = 12时辰
  1月 = 30天
  1年 = 12月

  游戏内1年 ≈ 现实约2-3小时游玩
```

### 时间的影响

**角色变化**
```yaml
凡人会老:
  - 阿檀如果不修炼，20年后就是中年，50年后就会老去
  - 这是推动她修炼的动力之一
  - 如果玩家闭关太久，出来可能阿檀已经嫁人/老去/死亡

修士寿命:
  - 练气期：150-200年
  - 筑基期：300-500年
  - 时间会流逝，但不会那么残酷
```

**世界变化**
```yaml
势力消长:
  - 宗门兴衰
  - 战争爆发与结束
  - 新势力崛起

人事变迁:
  - NPC会升职、离开、死亡
  - 仇人也会变强
  - 机缘可能错过

季节更替:
  - 春夏秋冬各有不同事件
  - 某些秘境只在特定时节开启
```

### 时间抉择

这是情感冲突的来源：

```
情境1：阿檀生病了
  - 选择A：陪她养病（花费1个月，错过一次重要机缘）
  - 选择B：去抢机缘（她可能好，也可能恶化）

情境2：师父闭关要突破
  - 你可以守护（花费1年，但师父成功率提高）
  - 你也可以外出历练（师父可能失败，甚至陨落）

情境3：仇人受伤了
  - 现在去追杀（放弃当前任务）
  - 等准备好再去（他可能恢复，也可能逃走）
```

---

## 二、关系系统

### 关系维度

每个重要NPC与玩家有多维度的关系：

```yaml
relationship_dimensions:
  trust: 0-100       # 信任：她相信你吗？
  affection: 0-100   # 情感：她对你有多少好感？
  respect: 0-100     # 尊敬：她尊敬你吗？
  dependency: 0-100  # 依赖：她有多需要你？
  understanding: 0-100 # 理解：她了解你吗？
```

### 关系变化

关系不是静态的，会因为行为而变化：

```yaml
positive_actions:
  - 关键时刻保护她：trust+15, affection+10
  - 记得她说过的话：affection+5, understanding+10
  - 为她放弃机缘：affection+20, dependency+10
  - 尊重她的选择：respect+10, trust+5
  - 对她坦诚相告：trust+10, understanding+5

negative_actions:
  - 欺骗她：trust-20
  - 忽视她的感受：affection-10
  - 把她当作棋子：respect-30, trust-20
  - 在关键时刻抛弃她：所有维度-50
  - 伤害她在乎的人：affection-30

neutral_but_significant:
  - 长时间不联系：dependency-5/月，但可能增加思念
  - 变得比她强太多：可能增加尊敬，也可能增加距离感
```

### 关系阈值与状态

```yaml
relationship_states:

  # 阿檀专属
  stranger: affection < 20              # 不可能，开局就是挚友
  friend: affection >= 40, trust >= 30  # 初始状态
  close_friend: affection >= 60, trust >= 50
  soulmate: affection >= 80, trust >= 70, understanding >= 60
  lover: affection >= 90, trust >= 80 + 特定剧情触发

  # 负面状态
  estranged: trust < 30                 # 疏远
  hurt: 被伤害后的特殊状态              # 需要修复
  broken: trust < 10                    # 可能无法修复
```

### 关系的可视化

玩家不会直接看到数值，而是通过：

```yaml
indirect_signals:
  对话态度:
    - 热情/冷淡
    - 主动找你/等你来找
    - 分享秘密/有所保留

  行为变化:
    - 会不会在你受伤时衣不解带照顾
    - 会不会为你做饭
    - 会不会在你做决定时发表意见

  称呼变化:
    - "你" → "你这家伙" → "[名字]" → 只有两人知道的昵称
```

---

## 三、记忆系统

AI要记住一切，才能让NPC"活"起来。

### 记忆类型

```yaml
memory_types:

  core_memory:      # 核心记忆，永不遗忘
    - 第一次相遇
    - 重大事件（生死关头、重大选择）
    - 深刻的情感体验

  significant_memory:  # 重要记忆，长期保留
    - 承诺和誓言
    - 冲突和和解
    - 共同经历的冒险

  casual_memory:    # 日常记忆，会随时间淡忘
    - 普通对话
    - 日常互动
    - 小事件

  emotional_memory: # 情感记忆，影响态度
    - 被伤害的感觉
    - 被保护的温暖
    - 被忽视的失落
```

### 记忆存储结构

```yaml
memory_entry:
  id: "mem_001"
  type: core_memory
  timestamp: "第一年春，入门第三日"

  event:
    what: "玩家在演武场被人欺负，阿檀冲出来护住玩家"
    who: ["玩家", "阿檀", "某弟子"]
    where: "青云门演武场"

  emotional_impact:
    阿檀:
      feeling: "担心、心疼、一点点骄傲"
      attitude_change: {affection: +5, dependency: +3}
    玩家:
      should_remember: true
      importance: 8

  consequences:
    - "阿檀之后更加关注玩家的安危"
    - "那个弟子记住了这件事"

  can_be_referenced: true  # 之后对话中可以提起
```

### 记忆的使用

AI在生成对话时会查询相关记忆：

```yaml
memory_query:
  场景: "玩家又要外出历练"
  查询: 与"分别""外出""危险"相关的记忆

  匹配记忆:
    - "上次玩家外出，差点死在外面"
    - "玩家承诺过会小心"
    - "阿檀最怕的就是失去玩家"

  生成的对话:
    阿檀: "你...又要走？"
    （她没有直接说不让你去，但语气里满是担忧）
    阿檀: "上次你回来满身是血，我..."
    （她顿了顿，低下头）
    阿檀: "你答应过我会小心的。"
```

---

## 四、选择与后果系统

### 选择的类型

```yaml
choice_types:

  dialogue_choice:    # 对话选择
    影响: 主要影响关系和态度
    例子:
      - 怎么回应阿檀的担心
      - 是否对师父说实话

  action_choice:      # 行动选择
    影响: 影响剧情走向和世界状态
    例子:
      - 救谁不救谁
      - 去哪里不去哪里

  value_choice:       # 价值选择
    影响: 定义玩家的"性格"，影响长期走向
    例子:
      - 正道还是魔道
      - 仁慈还是冷酷
      - 为友情放弃利益，还是相反

  time_choice:        # 时间选择
    影响: 资源分配和机会成本
    例子:
      - 闭关还是陪伴
      - 现在去还是准备好再去
```

### 后果的延迟

好的选择系统，后果不是立即显现的：

```yaml
consequence_timing:

  immediate:          # 立即后果
    - 对话态度变化
    - 简单的是/否结果

  short_term:         # 短期后果（数天到数月）
    - 关系变化
    - 引发的小事件

  long_term:          # 长期后果（数年甚至下一世）
    - 性格形成
    - 命运改变
    - 某些选择的"报应"

  hidden:             # 隐藏后果
    - 玩家不知道的影响
    - 埋下的伏笔
    - 多周目才能发现的关联
```

### 蝴蝶效应

```yaml
butterfly_effect:

  起点: "第一年春，玩家选择帮助一个老乞丐"

  直接后果:
    - 获得老乞丐的感谢
    - 损失了一点银两

  延迟后果:
    第一年夏: 老乞丐其实是个落魄散修，记住了玩家
    第三年: 玩家遇险，老乞丐出手相救
    第十年: 老乞丐临终，传授玩家一门绝学

  如果没有帮助:
    - 老乞丐死在那个冬天
    - 那场危机玩家要靠自己
    - 那门绝学永远不会获得
```

---

## 五、修炼系统

### 简化的数值

不追求复杂的数值系统，而是追求有意义的成长：

```yaml
core_stats:

  realm:              # 境界（最重要的指标）
    current: "练气期三层"
    exp: 340/500      # 当前经验/升级所需

  attributes:         # 基础属性（跟境界挂钩）
    hp: 当前/最大
    mp: 当前/最大
    attack: 攻击力
    defense: 防御力
    speed: 速度

  special:            # 特殊属性
    comprehension: 悟性（影响修炼速度和领悟技能）
    fortune: 气运（影响随机事件）
    karma: 因果（善恶值，影响某些剧情和结局）
```

### 修炼的方式

```yaml
cultivation_methods:

  日常修炼:
    - 每日打坐，稳定提升
    - 安全但缓慢

  功法修炼:
    - 使用特定功法，效率更高
    - 功法有品阶和契合度

  战斗感悟:
    - 生死之间最容易突破
    - 高风险高回报

  机缘突破:
    - 秘境奇遇
    - 奇物辅助
    - 高人指点

  以心证道:
    - 经历刻骨铭心的事件
    - 情感上的巨大波动可能触发突破
    - 例：阿檀遇险，玩家悲愤之下突破
```

### 功法系统

```yaml
cultivation_technique:

  id: "qingyun_heart_sutra"
  name: "青云心经"
  grade: "玄品下阶"

  description: "青云门入门心法，中正平和"

  requirements:
    - 青云门弟子
    - 练气期以上

  effects:
    exp_multiplier: 1.2   # 修炼效率
    mp_regen: +10%        # 法力恢复

  conflicts:             # 不能同修的功法
    - "幽冥诀"           # 魔道功法
    - "焚天诀"           # 太过霸道

  synergies:             # 配合更好的功法
    - "明心诀"           # 辅助心法
```

### 技能/武技系统

```yaml
skill:

  id: "cloud_sword"
  name: "云霞剑法"
  type: "主动技能"

  description: "青云门基础剑法，以柔克刚"

  requirements:
    realm: "练气期一层"
    weapon: "剑"

  cost:
    mp: 20

  effects:
    damage: "攻击力 * 1.5"
    special: "有几率使敌人减速"

  mastery:              # 熟练度
    current: 45/100
    levels:
      - 入门 (0-30): 基础威力
      - 熟练 (31-60): 解锁连招
      - 精通 (61-90): 减少消耗
      - 大成 (91-100): 领悟奥义
```

---

## 六、战斗系统

### 战斗理念

战斗不是刷刷刷，而是：
- **有策略**：需要思考而不是无脑按技能
- **有风险**：可能会死，所以要认真对待
- **有叙事**：战斗本身也是故事的一部分

### 战斗流程

```yaml
combat_flow:

  开始:
    - 描述敌人和环境
    - 显示双方状态

  每回合:
    玩家选择:
      - 攻击（普通攻击/技能）
      - 防御（减少伤害，恢复少量MP）
      - 道具（使用丹药等）
      - 特殊（根据情境：逃跑、喊话、环境互动）

    敌人行动:
      - 根据AI决策
      - 不是纯随机，有性格影响

    结算:
      - 伤害计算
      - 状态变化
      - 战斗叙事

  结束:
    - 胜利：奖励、成长、后续
    - 失败：后果（死亡？重伤？被俘？）
    - 特殊：敌人逃跑、第三方介入、战斗中断
```

### 战斗特殊机制

```yaml
special_mechanics:

  境界压制:
    - 高一个大境界：伤害+50%，受伤-30%
    - 高两个大境界：几乎碾压
    - 这就是为什么不能莽撞

  五行克制:
    - 金克木、木克土、土克水、水克火、火克金
    - 被克：伤害+30%
    - 克制：伤害-20%

  状态效果:
    - 中毒：持续掉血
    - 眩晕：跳过回合
    - 虚弱：属性下降
    - 狂暴：攻击上升，防御下降

  战斗中的选择:
    - 敌人求饶时：杀/放
    - 第三方介入时：帮谁
    - 战况不利时：死战/逃跑/求援
```

### 战斗的后果

```yaml
combat_consequences:

  胜利:
    - 经验值
    - 可能的掉落
    - 对关系的影响（如果有人在看）
    - 对名声的影响

  失败但存活:
    - 重伤（需要时间恢复）
    - 可能被俘
    - 可能失去某些东西
    - 对自信的打击（影响后续剧情）

  死亡:
    - 触发轮回机制
    - 世界继续演化
    - 某些羁绊可能保留
```

---

## 七、轮回系统

### 死亡触发

```yaml
death_trigger:

  conditions:
    - HP归零且无法被救
    - 某些剧情的必然死亡

  before_death:
    - 最后的场景描写
    - 可能的遗言或闪回
    - 重要NPC的反应（如果在场）
```

### 轮回机制

```yaml
reincarnation:

  世界处理:
    - 时间快进（10-100年，取决于设定）
    - 世界继续演化
    - NPC们的命运变化

  角色继承:
    karma_inheritance:        # 因果继承
      - 前世的善恶会影响今生的初始气运
      - 极善：开局有贵人相助
      - 极恶：开局有冤魂纠缠

    memory_fragments:         # 记忆碎片
      - 不是完整记忆，而是"似曾相识"
      - 见到某人/某地会触发模糊的感觉
      - 重要抉择时可能闪过前世画面

    relationship_echoes:      # 关系回响
      - 前世的挚爱，今生可能无端心动
      - 前世的仇人，今生可能无端厌恶
      - 前世的遗憾，今生可能执念更深

  新开局变化:
    - 新的身份（可能是不同地方出生）
    - 新的初始条件
    - 但某些NPC还活着（如果寿命足够）
    - 某些事件已成历史
```

### 多周目设计

```yaml
new_game_plus:

  第一周目:
    - 正常体验
    - 揭开部分真相
    - 必然有遗憾

  第二周目:
    - 带着记忆碎片开始
    - 可以做不同选择
    - 揭开更多真相
    - 可能弥补前世遗憾，也可能制造新遗憾

  多周目累积:
    - 因果纠缠越来越深
    - 某些角色会"觉醒"前世记忆
    - 最终真相需要多周目才能完全揭开

  隐藏结局:
    - 需要特定条件（多周目积累）
    - 打破轮回？
    - 与命运和解？
```

---

## 八、AI叙事系统

### AI的角色

```yaml
ai_role:

  不是:
    - 生成漂亮的描写词藻
    - 机械地填充模板
    - 只做表面的对话生成

  而是:
    - 扮演每一个NPC
    - 理解当前情境和历史
    - 做出符合人设的反应
    - 推动故事发展
```

### 上下文构建

```yaml
context_for_ai:

  每次生成前，AI需要知道:

    世界状态:
      - 当前时间
      - 当前地点
      - 近期发生的大事

    角色状态:
      - 玩家当前的属性、心情、目标
      - 相关NPC的记忆和态度

    场景信息:
      - 这是什么情境
      - 有谁在场
      - 刚刚发生了什么

    历史记忆:
      - 相关的核心记忆
      - 最近的交互
      - 未解决的冲突或承诺
```

### NPC扮演

```yaml
npc_persona:

  每个NPC有:
    - 核心性格
    - 说话风格
    - 当前心情
    - 对玩家的态度
    - 自己的目标
    - 不会说的话（禁忌）
    - 会说的口头禅

  AI扮演NPC时:
    - 不能打破人设
    - 要考虑记忆和情感
    - 要有自己的诉求，不是玩家的提线木偶
    - 可以拒绝玩家，可以生气，可以主动提出要求
```

### 叙事风格

```yaml
narrative_style:

  原则:
    - 简洁有力，不堆砌辞藻
    - 重要时刻才浓墨重彩
    - 对话要像真人说话
    - 留白比说满更好

  示例:
    差:
      "阿檀那双如秋水般的眼眸中泛着点点泪光，
       她樱唇轻启，用如黄莺般悦耳的声音说道..."

    好:
      "阿檀看着你，眼圈红了。
       '你...又要走？'"
```

---

## 九、存档与持久化

### 存储结构

```yaml
save_data:

  world_state:           # 世界状态
    current_time: ...
    faction_states: ...
    world_events: ...

  player_state:          # 玩家状态
    character: ...
    inventory: ...
    skills: ...
    quest_log: ...

  npc_states:            # NPC状态
    characters:
      - id: atan
        relationship: ...
        memories: ...
        current_state: ...

  story_state:           # 剧情状态
    main_quest_progress: ...
    flags: ...           # 剧情标记

  meta:                  # 元数据
    play_time: ...
    save_time: ...
    death_count: ...     # 轮回次数
    karma_total: ...     # 累积因果
```

### 自动保存

```yaml
auto_save:
  triggers:
    - 重要选择后
    - 战斗结束后
    - 进入新场景
    - 每隔固定时间（如15分钟）

  slots:
    - 最新自动存档
    - 次新自动存档
    - 手动存档（多个槽位）
```

---

*本文档定义了游戏的核心系统。每个系统都是为"让玩家在乎"服务的，而不是为了复杂而复杂。*
